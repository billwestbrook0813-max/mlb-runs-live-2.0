<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Salami Slider — MLB Runs</title>
  <!-- Early 2000s sports-bar vibe fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Oswald:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0d12;
      --panel:#121823;
      --line:#2a3342;
      --neon:#ff355e;
      --neon2:#c6ff00;
      --text:#e9eef6;
      --muted:#9bb0c7;
      --card:#16202e;
      --card2:#1a2331;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Oswald', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at -10% -20%, rgba(198,255,0,.10), transparent 60%),
        radial-gradient(900px 600px at 110% -10%, rgba(255,53,94,.12), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    /* Header */
    header.salami{
      width:100%;
      display:flex; align-items:center; gap:14px; padding:10px 14px;
      position:sticky; top:0; z-index:5;
      background: linear-gradient(180deg, rgba(18,24,35,.95), rgba(18,24,35,.70) 60%, transparent);
      border-bottom:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
    }
    header.salami img.brand{height:60px; width:auto; filter: drop-shadow(0 6px 16px rgba(0,0,0,.5));}
    header.salami .title{flex:1; text-align:center}
    header.salami img.title-logo{height:70px; width:auto; filter: drop-shadow(0 10px 22px rgba(0,0,0,.55));}

    /* Big number with TV-ish outline glow */
    .big{
      font-family:'Anton', Impact, Haettenschweiler, 'Arial Black', sans-serif;
      font-size:16vw; line-height:1; letter-spacing:.5px;
      text-shadow:
        0 0 0 #000,
        0 2px 0 rgba(0,0,0,.45),
        0 8px 18px rgba(0,0,0,.45),
        0 0 12px rgba(255,53,94,.25);
      -webkit-text-stroke: 1px rgba(255,255,255,.04);
    }

    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:18px}

    /* Cards */
    .row{display:flex;gap:14px;flex-wrap:wrap;justify-content:center}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border:1px solid rgba(255,255,255,.09);
      border-radius:16px;
      padding:12px 14px;
      box-shadow: 0 14px 26px rgba(0,0,0,.28);
      backdrop-filter: blur(2px);
    }
    .card .label{font-size:.9rem; color:var(--muted); letter-spacing:.02em}
    .card .value{font-family:'Anton', Impact, Haettenschweiler, 'Arial Black', sans-serif; font-size:2rem; letter-spacing:.5px}

    /* Highlight card */
    .highlight{border-color: rgba(255,53,94,.45); box-shadow: 0 10px 24px rgba(255,53,94,.18);}

    /* Progress bar */
    .progress-outer{height:24px;border:1px solid rgba(255,255,255,.09);border-radius:14px;overflow:hidden;background:linear-gradient(180deg,#0e1420,#0b1019);}
    .progress-inner{height:100%;transition:width .35s ease-out;background: linear-gradient(90deg,var(--neon), #f89b29);}

    /* Ticker */
    .ticker{width:min(1100px,96%);overflow:hidden;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:#0f1622;height:42px;display:flex;align-items:center;box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .ticker__track{display:inline-flex;gap:24px;white-space:nowrap;will-change:transform;animation:ticker-move 35s linear infinite;padding:0 12px;font-size:15px;}
    .ticker__item{display:inline-flex;align-items:center;gap:8px;}
    .ticker__pill{font-size:12px;opacity:.85;border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:2px 8px;background:#131c2a}
    @keyframes ticker-move{from{transform:translateX(0)} to{transform:translateX(-50%)}}
    .ticker__track.noscroll{animation:none !important;transform:none !important;}

    .meta{opacity:.8}

    /* Small heading style for section captions */
    .caption{
      font-family:'Anton', Impact, Haettenschweiler, 'Arial Black', sans-serif;
      letter-spacing:.04em; font-size:1rem; opacity:.8;
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
<header class="salami">
  <img class="brand" src="assets/juice-junkies-logo.png" alt="Juice Junkies Logo" />
  <div class="title">
    <img class="title-logo" src="assets/salami-slider-logo.png" alt="The Salami Slider" />
  </div>
  <div style="width:60px"></div>
</header>

<div class="wrap">
  <div class="big" id="total">—</div>

  <div class="row">
    <div class="card"><div class="label">Games counted</div><div class="value"><span id="games">—</span></div></div>
    <div class="card"><div class="label">Date (PT)</div><div class="value"><span id="date">—</span></div></div>
    <div class="card"><div class="label">Last update</div><div class="value"><span id="updated">—</span></div></div>
  </div>

  <div class="row">
    <div class="card"><div class="label">Projected total (juice‑adjusted)</div><div class="value"><span id="proj">—</span></div></div>
    <div class="card"><div class="label">Band (±1σ)</div><div class="value"><span id="band">—</span></div></div>
    <div class="card"><div class="label">Market lean</div><div class="value"><span id="lean">—</span></div></div>
  </div>

  <!-- Headline cards for ALL LIVE GAMES -->
  <div class="row">
    <div class="card"><div class="label">Projected Live (All Non‑Final Games)</div><div class="value"><span id="projLiveAll">—</span></div></div>
    <div class="card highlight"><div class="label">Projected Total (Actual – LiveActual + LiveProjected)</div><div class="value"><span id="projTotal">—</span></div></div>
  </div>

  <div style="width:min(900px,92%);margin:0 auto;">
    <div class="caption" style="margin:.25rem 0 .5rem;">Actual vs Projected</div>
    <div class="progress-outer"><div class="progress-inner" id="bar" style="width:0%"></div></div>
    <div class="row" style="justify-content:space-between;margin-top:.4rem;">
      <div class="meta">Actual: <span id="actual">0</span></div>
      <div class="meta">Projected: <span id="proj2">—</span> (<span id="pct">0%</span>)</div>
    </div>
  </div>

  <div class="ticker" id="ticker"><div class="ticker__track" id="tickerTrack"></div></div>

  <div class="card" id="oulist" style="max-width:1100px;text-align:left"></div>
</div>

<script>
function fmtPT(d){
  return new Intl.DateTimeFormat('en-US',{ timeZone:'America/Los_Angeles', hour:'2-digit', minute:'2-digit', second:'2-digit' }).format(d);
}
async function getActual(){ const r = await fetch(`/api/total-runs`); if(!r.ok) throw new Error('actual'); return r.json(); }
async function getProj(){ const r = await fetch(`/api/projected-runs`); if(!r.ok) throw new Error('proj'); return r.json(); }
async function getBoard(){ const r = await fetch(`/api/scoreboard`); if(!r.ok) throw new Error('board'); return r.json(); }
function setText(id, v){ const el = document.getElementById(id); if (el) el.textContent = v; }

// Team name map for matching Odds API to scoreboard abbreviations
const TEAM_MAP = {
  ARI: "Arizona Diamondbacks", ATL: "Atlanta Braves", BAL: "Baltimore Orioles", BOS: "Boston Red Sox",
  CHC: "Chicago Cubs", CIN: "Cincinnati Reds", CLE: "Cleveland Guardians", COL: "Colorado Rockies",
  CWS: "Chicago White Sox", DET: "Detroit Tigers", HOU: "Houston Astros", KC: "Kansas City Royals",
  LAA: "Los Angeles Angels", LAD: "Los Angeles Dodgers", MIA: "Miami Marlins", MIL: "Milwaukee Brewers",
  MIN: "Minnesota Twins", NYM: "New York Mets", NYY: "New York Yankees", OAK: "Oakland Athletics",
  PHI: "Philadelphia Phillies", PIT: "Pittsburgh Pirates", SDP: "San Diego Padres", SEA: "Seattle Mariners",
  SFG: "San Francisco Giants", STL: "St. Louis Cardinals", TBR: "Tampa Bay Rays", TEX: "Texas Rangers",
  TOR: "Toronto Blue Jays", WSH: "Washington Nationals",
  TB: "Tampa Bay Rays", SD: "San Diego Padres" // common alt abbreviations
};

function matchOddsGame(oddsGames, sbItem){
  const awayFull = TEAM_MAP[sbItem.away] || sbItem.away;
  const homeFull = TEAM_MAP[sbItem.home] || sbItem.home;
  return oddsGames.find(g => {
    const a = (g.away_team || '').toLowerCase();
    const h = (g.home_team || '').toLowerCase();
    return (a.includes(awayFull.toLowerCase()) && h.includes(homeFull.toLowerCase())) ||
           (a.includes(sbItem.away.toLowerCase()) && h.includes(sbItem.home.toLowerCase()));
  }) || null;
}

async function refreshAll(){
  try{
    const [a, p, b] = await Promise.all([getActual(), getProj(), getBoard()]);

    const actual = a.totalRuns ?? 0;
    const projAdj = p.projectedRuns ?? 0;
    const projRaw = p.projectedRuns_raw ?? projAdj;
    const low = p.bandLow ?? projAdj;
    const high = p.bandHigh ?? projAdj;
    const leanRuns = (projAdj - projRaw);

    setText('total', actual);
    setText('actual', actual);
    setText('games', a.gamesCount ?? '0');
    setText('date', a.date ?? '—');
    setText('updated', fmtPT(new Date()));

    setText('proj', Number(projAdj).toFixed(1));
    setText('proj2', Number(projAdj).toFixed(1));
    setText('band', `${Number(low).toFixed(1)} – ${Number(high).toFixed(1)}`);
    setText('lean', `${leanRuns>=0?'+':''}${Number(leanRuns).toFixed(1)} runs`);

    const pct = projAdj>0 ? Math.min(150,(actual/projAdj)*100) : 0;
    document.getElementById('bar').style.width = `${pct.toFixed(1)}%`;
    setText('pct', `${(actual&&projAdj)? pct.toFixed(0):0}%`);

    // ALL non-final games: swap their partial actuals for their projections
    const items = b.items || [];
    const nonFinal = items.filter(it => it.state !== "Final");

    let sumLiveActual = 0;
    let sumLiveProjected = 0;

    for (const it of nonFinal){
      const liveActual = Number(it.as || 0) + Number(it.hs || 0);
      sumLiveActual += liveActual;
      const match = matchOddsGame(p.games || [], it);
      if (match){
        const pg = (match.consensus_total_adj ?? match.consensus_total) || 0;
        sumLiveProjected += Number(pg);
      } else {
        // If we can't match projections, keep the actual so totals remain consistent
        sumLiveProjected += liveActual;
      }
    }

    const projTotal = Math.round(((actual - sumLiveActual) + sumLiveProjected) * 100) / 100;

    setText('projLiveAll', Number(sumLiveProjected).toFixed(1));
    setText('projTotal', projTotal.toFixed(1));

    // OU list (unchanged)
    const ouText = (p.games||[]).map(g => {
      const adj = g.consensus_total_adj ?? g.consensus_total;
      const delta = adj - g.consensus_total;
      const dstr = (isFinite(delta) && !Number.isNaN(delta)) ? ` (adj ${delta>=0?'+':''}${delta.toFixed(2)})` : '';
      return `${g.away_team || g.away} @ ${g.home_team || g.home}: ${Number(adj).toFixed(2)}${dstr} (n=${g.bookmakers_count}, ${g.status})`;
    }).join(' · ');
    const oulist = document.getElementById('oulist'); if (oulist) oulist.textContent = ouText;

  }catch(e){ console.error(e); }
}

function formatItem(it){ return `${it.away} ${it.as} — ${it.home} ${it.hs}  |  ${it.tag}`; }
async function refreshTicker(){
  try{
    const j = await getBoard();
    const items = j.items || [];
    const track = document.getElementById('tickerTrack');
    const ticker = document.getElementById('ticker');
    if (!track || !ticker) return;

    const nodes = items.map(it => {
      const div = document.createElement('div');
      div.className = 'ticker__item';
      div.textContent = formatItem(it);
      const pill = document.createElement('span');
      pill.className = 'ticker__pill';
      pill.textContent = it.state;
      div.appendChild(pill);
      return div;
    });

    track.innerHTML = '';
    for (let i=0;i<2;i++) nodes.forEach(n => track.appendChild(n.cloneNode(true)));

    if (track.scrollWidth <= ticker.clientWidth) {
      track.classList.add('noscroll');
    } else {
      track.classList.remove('noscroll');
    }

    if (!ticker._hoverBound){
      ticker.addEventListener('mouseenter', () => track.style.animationPlayState = 'paused');
      ticker.addEventListener('mouseleave', () => track.style.animationPlayState = 'running');
      ticker._hoverBound = true;
    }
  }catch(e){ console.error(e); }
}

refreshAll();
refreshTicker();
setInterval(refreshAll, 15000);
setInterval(refreshTicker, 15000);
</script>
</body>
</html>
